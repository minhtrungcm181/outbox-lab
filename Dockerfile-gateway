# --- Build stage ---
FROM golang:1.24.5-alpine AS builder
RUN apk add --no-cache ca-certificates tzdata git
ENV GOPROXY=https://proxy.golang.org,direct

WORKDIR /src

# 1) Copy only the modules you need
COPY gateway/ ./gateway
COPY shared/        ./shared
COPY .env .env

# 2) Create a temporary workspace so local module imports resolve
RUN go work init ./gateway ./shared

# 3) (Optional but helps caching) download deps for both
RUN go -C shared mod download || true
RUN go -C gateway mod download

# 4) Build the poller binary from its module
RUN go build -C gateway -o /gateway ./cmd/gateway

# --- Runtime stage ---
FROM alpine:3.20
ENV TZ=Asia/Ho_Chi_Minh
RUN apk add --no-cache ca-certificates tzdata \
 && ln -snf /usr/share/zoneinfo/$TZ /etc/localtime \
 && echo $TZ > /etc/timezone \
 && adduser -D -H -u 10001 appuser

USER appuser
WORKDIR /home/appuser

COPY --from=builder /gateway ./gateway
ENTRYPOINT ["./gateway"]
